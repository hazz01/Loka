# Update Documentation - AI Trip Planner Response Format

## Tanggal Update
31 Januari 2026

## Ringkasan Perubahan
Mengupdate model response dari AI Trip Planner agar sesuai dengan format endpoint terbaru yang lebih sederhana dan fokus pada struktur `days` dengan `activities`.

## Format Response Endpoint Baru

```json
{
  "tripPlanId": "string (optional - generated by Firestore)",
  "userId": "string",
  "summary": "string (brief summary of the trip plan)",
  "totalEstimatedCost": number,
  "days": [
    {
      "dayNumber": integer,
      "activities": [
        {
          "destinationId": "string (EXACT Firestore ID)",
          "startTime": "string (HH:mm format)",
          "endTime": "string (HH:mm format)",
          "notes": "string (optional)"
        }
      ]
    }
  ]
}
```

## File yang Diubah

### 1. `lib/features/home/models/trip_response_model.dart`
**Perubahan:**
- Simplifikasi struktur `TripResponse` agar langsung menggunakan field baru: `tripPlanId`, `userId`, `summary`, `totalEstimatedCost`, dan `days`
- Menambahkan error handling yang lebih robust di `fromJson()`
- Menambahkan backward compatibility getters untuk kode lama yang masih menggunakan field seperti `tripName`, `city`, `dailyItinerary`, dll
- Update `DaySchedule` dan `ActivitySchedule` untuk parsing yang lebih aman dengan try-catch
- Field `destinationId` sekarang optional (bisa null)
- Field `activityType` memiliki default value 'visit'

**Backward Compatibility:**
- Model lama tetap didukung melalui computed properties:
  - `tripName` â†’ returns 'AI Generated Trip'
  - `city` â†’ returns 'Various Locations'
  - `totalBudget` â†’ converts from `totalEstimatedCost`
  - `dailyItinerary` â†’ mapped dari `days`
  - `budgetSummary` â†’ generated dari data yang ada

### 2. `lib/features/home/pages/timeline_trip_Page.dart`
**Perubahan:**
- Update method `_loadApiData()` untuk menggunakan struktur `response.days` langsung
- Menambahkan try-catch untuk fallback ke dummy data jika parsing gagal
- Mapping activities langsung dari `DaySchedule.activities`
- Menggunakan default values untuk field yang tidak tersedia (imagePath, price, dll)

**Error Handling:**
- Jika parsing gagal, otomatis fallback ke `_loadDummyData()`
- Print error message untuk debugging

### 3. `TEST_RESPONSE_FORMAT.json` (New File)
**Tujuan:**
- Contoh format response yang sesuai dengan endpoint baru
- Dapat digunakan untuk testing dan validasi
- Menunjukkan struktur data yang diharapkan

## Keuntungan Format Baru

1. **Lebih Sederhana**: Struktur data lebih flat dan mudah dipahami
2. **Fokus pada Destinasi**: Field `destinationId` memastikan referensi yang akurat ke Firestore
3. **Fleksibel**: Field optional seperti `tripPlanId` dan `notes` memberikan fleksibilitas
4. **Error Safe**: Parsing dengan error handling yang baik mencegah crash

## Cara Testing

### Test dengan Data Sample
```dart
// Contoh response dari endpoint
final sampleResponse = {
  "tripPlanId": "trip_12345",
  "userId": "user123",
  "summary": "3-day trip to Batu",
  "totalEstimatedCost": 1500000,
  "days": [
    {
      "dayNumber": 1,
      "activities": [
        {
          "destinationId": "dest001",
          "startTime": "09:00",
          "endTime": "11:30",
          "notes": "Visit Museum Angkut"
        }
      ]
    }
  ]
};

// Parse ke model
final tripResponse = TripResponse.fromJson(sampleResponse);
```

### Test Flow Lengkap
1. Buka aplikasi
2. Navigate ke Trip AI Planner
3. Pilih "Greater City" atau kategori lainnya
4. Isi form dengan data lengkap
5. Submit dan tunggu response dari endpoint
6. Timeline page harus menampilkan data tanpa error

## Validasi Response

### Response HARUS Memiliki:
- âœ… `userId` (required)
- âœ… `summary` (required)
- âœ… `days` array (required)
  - âœ… `dayNumber` (required)
  - âœ… `activities` array (required)
    - âœ… `startTime` (required)
    - âœ… `endTime` (required)

### Response BISA Memiliki (Optional):
- ğŸ“ `tripPlanId`
- ğŸ“ `totalEstimatedCost` (default: 0)
- ğŸ“ `activities[].destinationId`
- ğŸ“ `activities[].notes`

## Error Handling

### Jika Response Invalid:
1. Print error ke console untuk debugging
2. Return object minimal yang valid (tidak crash)
3. Fallback ke dummy data di timeline page

### Contoh Error Handling:
```dart
try {
  return TripResponse(
    tripPlanId: json['tripPlanId'],
    userId: json['userId'] ?? '',
    summary: json['summary'] ?? '',
    totalEstimatedCost: cost,
    days: daysList,
  );
} catch (e) {
  print('Error parsing TripResponse: $e');
  return TripResponse(
    userId: '',
    summary: 'Error parsing response',
    totalEstimatedCost: 0,
    days: [],
  );
}
```

## Breaking Changes

### Tidak Ada Breaking Changes
Semua perubahan backward compatible melalui computed properties. Kode lama yang menggunakan field seperti `tripName`, `city`, `dailyItinerary`, dll akan tetap berfungsi.

## Migration Guide untuk Developer

Jika Anda ingin menggunakan format baru secara langsung:

**Sebelum:**
```dart
final tripName = response.tripName;
final city = response.city;
final itinerary = response.dailyItinerary;
```

**Sesudah:**
```dart
final summary = response.summary;
final days = response.days;
final cost = response.totalEstimatedCost;
```

## Checklist Testing

- [ ] Response dengan semua field required â†’ âœ… Display OK
- [ ] Response dengan field optional kosong â†’ âœ… Display OK  
- [ ] Response dengan format invalid â†’ âœ… Fallback to dummy data
- [ ] Activities tanpa destinationId â†’ âœ… Display dengan ID kosong
- [ ] Activities tanpa notes â†’ âœ… Display tanpa catatan
- [ ] Days array kosong â†’ âœ… Display "No days available"
- [ ] Multiple days dengan multiple activities â†’ âœ… Display semua

## Notes untuk Backend Developer

1. Pastikan `destinationId` adalah ID Firestore yang valid dan EXACT match
2. Format waktu harus 24-hour (HH:mm) contoh: "09:00", "14:30"
3. `startTime` harus lebih kecil dari `endTime`
4. `dayNumber` harus berurutan mulai dari 1
5. `summary` sebaiknya friendly dan professional
6. `totalEstimatedCost` adalah total semua biaya dalam satuan Rupiah

## Future Improvements

1. Validasi format waktu di client side
2. Caching response untuk offline access
3. Sync dengan Firestore untuk persistence
4. Image loading dari Firestore berdasarkan destinationId
5. Real price data dari Firestore berdasarkan destinationId
